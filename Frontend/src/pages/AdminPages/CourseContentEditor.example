import { useState, useMemo, useEffect } from "react";
import axios from "axios";
import debounce from "lodash.debounce";
import {
  FiPlus,
  FiVideo,
  FiFileText,
  FiLink,
  FiTrash2,
} from "react-icons/fi";
import { useParams } from "react-router-dom";

/* ================= MAIN EDITOR ================= */
const CourseContentEditor = () => {
  const [chapters, setChapters] = useState([]);
  const { courseId } = useParams();

  /* ===== ADD CHAPTER ===== */
  const addChapter = async () => {
    const tempId = Date.now();

    setChapters(prev => [
      ...prev,
      { _id: tempId, title: "" },
    ]);

    try {
      const res = await axios.post(
        `${import.meta.env.VITE_BACKEND_URL}/api/v1/chapters/${courseId}`,
        { title: "New Chapter" },
        { withCredentials: true }
      );

      setChapters(prev =>
        prev.map(c => (c._id === tempId ? {...(res.data.data)} : c))
      );
    } catch {
      setChapters(prev => prev.filter(c => c._id !== tempId));
    }
  };

  /* ===== DELETE CHAPTER ===== */
  const deleteChapter = async (chapterId) => {
    const snapshot = chapters;
    setChapters(prev => prev.filter(c => c._id !== chapterId));

    try {
      await axios.delete(
        `${import.meta.env.VITE_BACKEND_URL}/api/v1/chapters/${chapterId}`,
        { withCredentials: true }
      );
    } catch {
      setChapters(snapshot);
    }
  };

  /* ===== LOCAL UPDATE ===== */
  const updateChapterLocal = (id, data) => {
    console.log(data)
    setChapters(prev =>{
      const arr = prev.map(c => {
        console.log(c._id == id)
        if (c._id === id) {
          return { ...c, ...data };
        }else{
          return {...c};
        }
      });
      return arr;
  });
    console.log(chapters)
  };

  /* ===== SAVE CHAPTER TITLE ===== */
  const saveChapterTitle = useMemo(
    () =>
      debounce(async (id, title) => {
        await axios.patch(
          `${import.meta.env.VITE_BACKEND_URL}/api/v1/chapters/${id}`,
          { title },
          { withCredentials: true }
        );
      }, 600),
    []
  );

  /* ===== INITIAL FETCH ===== */
  useEffect(() => {
    axios
      .get(
        `${import.meta.env.VITE_BACKEND_URL}/api/v1/chapters/${courseId}/all`,
        { withCredentials: true }
      )
      .then(res => setChapters(res.data.data))
      .catch(console.log);
  }, []);

  return (
    <div className="max-w-6xl px-6 py-10 space-y-10">
      <div>
        <h1 className="text-2xl font-semibold text-gray-900">Course Content</h1>
        <p className="text-sm text-gray-500">
          Organize chapters, lessons and resources
        </p>
      </div>

      <button
        onClick={addChapter}
        className="inline-flex items-center gap-2 rounded-xl border border-blue-200 bg-blue-50 px-4 py-2 text-sm font-medium text-blue-700 hover:bg-blue-100"
      >
        <FiPlus /> Add Chapter
      </button>

      <div className="space-y-6">
        {chapters.map(chapter => (
          <ChapterCard
            key={chapter._id}
            chapter={chapter}
            onDelete={deleteChapter}
            onLocalUpdate={updateChapterLocal}
            onSaveTitle={saveChapterTitle}
          />
        ))}
      </div>
    </div>
  );
};

export default CourseContentEditor;

/* ================= CHAPTER ================= */
const ChapterCard = ({ chapter, onDelete, onLocalUpdate, onSaveTitle }) => {
  /* ===== ADD LESSON ===== */
  const addLesson = async () => {
    const tempId = Date.now();
    console.log(chapter)
    // 1ï¸âƒ£ Optimistic add
    onLocalUpdate(chapter._id,{
      lessons:[...(chapter.lessons || []),{_id:tempId,title:"new Lesson",resources:[]}]
    });
    console.log(chapter)
    try {
      const res = await axios.post(
        `${import.meta.env.VITE_BACKEND_URL}/api/v1/lessons/${chapter._id}`,
        { title: "New Lesson" },
        { withCredentials: true }
      );

      // 2ï¸âƒ£ Replace temp lesson with backend lesson (SAFE)
      onLocalUpdate(chapter._id,{
        lessons:chapter.lessons.map((c)=>c._id===tempId ? res.data.data : c)
      });
    } catch {
      // 3ï¸âƒ£ Rollback on failure
      onLocalUpdate(chapter._id,{
        lessons: chapter.lessons.filter(l => l._id !== tempId),
      });
    }
  };

  /* ===== DELETE LESSON ===== */
  const deleteLesson = async (lessonId) => {
    // Optimistic removal
    onLocalUpdate(chapter._id, ((prevChapter) => ({
      ...prevChapter,
      lessons: prevChapter.lessons.filter(l => l._id !== lessonId),
    }))());

    // ðŸš« Skip backend for temp lesson
    if (lessonId.toString().length !== 24) return;

    await axios.delete(
      `${import.meta.env.VITE_BACKEND_URL}/api/v1/lessons/${lessonId}`,
      { withCredentials: true }
    );
  };

  return (
    <section className="rounded-2xl border border-gray-200/60 bg-white shadow-sm p-6 space-y-5">
      <div className="flex items-center gap-3">
        <input
          value={chapter.title}
          onChange={e => {
            onLocalUpdate(chapter._id, { title: e.target.value });
            if (e.target.value.trim()) {
              onSaveTitle(chapter._id, e.target.value);
            }
          }}
          placeholder="Chapter title"
          className="w-full rounded-lg border px-3 py-2 text-sm font-medium"
        />

        <button onClick={() => onDelete(chapter._id)}>
          <FiTrash2 className="text-gray-400 hover:text-red-500" />
        </button>
      </div>

      <div className="space-y-4 pl-4 border-l">
        {chapter.lessons?.map(lesson => (
          <LessonCard
            key={lesson._id}
            lesson={lesson}
            chapterId={chapter._id}
            lessons={chapter.lessons}
            onLocalUpdate={onLocalUpdate}
            onDeleteLesson={deleteLesson}
          />
        ))}

        <button
          onClick={addLesson}
          className="text-sm text-blue-600 hover:underline"
        >
          + Add Lesson
        </button>
      </div>
    </section>
  );
};


/* ================= LESSON ================= */
const LessonCard = ({
  lesson,
  chapterId,
  lessons,
  onLocalUpdate,
  onDeleteLesson,
}) => {
  /* ===== SAVE LESSON TITLE ===== */
  const saveLessonTitle = useMemo(
    () =>
      debounce(async (id, title) => {
        // ðŸš« skip temp lesson
        if (id.toString().length !== 24) return;

        await axios.patch(
          `${import.meta.env.VITE_BACKEND_URL}/api/v1/lessons/${id}`,
          { title },
          { withCredentials: true }
        );
      }, 600),
    []
  );

  /* ===== ADD RESOURCE ===== */
  const addResource = (type) => {
    onLocalUpdate(chapterId, {
      lessons: lessons.map(l =>
        l._id === lesson._id
          ? {
              ...l,
              resources: [...(l.resources || []), { _id: Date.now(), type }],
            }
          : l
      ),
    });
  };

  /* ===== DELETE RESOURCE ===== */
  const deleteResource = (resourceId) => {
    onLocalUpdate(chapterId, {
      lessons: lessons.map(l =>
        l._id === lesson._id
          ? {
              ...l,
              resources: l.resources.filter(r => r._id !== resourceId),
            }
          : l
      ),
    });
  };

  return (
    <div className="rounded-xl border border-gray-200/60 bg-gray-50/70 p-4 space-y-4">
      <div className="flex items-center gap-3">
        <input
          value={lesson.title}
          onChange={e => {
            onLocalUpdate(chapterId, {
              lessons: lessons.map(l =>
                l._id === lesson._id
                  ? { ...l, title: e.target.value }
                  : l
              ),
            });

            if (e.target.value.trim()) {
              saveLessonTitle(lesson._id, e.target.value);
            }
          }}
          placeholder="Lesson title"
          className="w-full rounded-md border px-3 py-2 text-sm"
        />

        <button onClick={() => onDeleteLesson(lesson._id)}>
          <FiTrash2 className="text-gray-400 hover:text-red-500" />
        </button>
      </div>

      <div className="flex gap-4 text-xs">
        <button onClick={() => addResource("video")} className="text-blue-600">
          <FiVideo /> Video
        </button>
        <button onClick={() => addResource("pdf")} className="text-blue-600">
          <FiFileText /> PDF
        </button>
        <button onClick={() => addResource("link")} className="text-blue-600">
          <FiLink /> Link
        </button>
      </div>

      {lesson.resources?.map(r => (
        <div key={r._id} className="flex justify-between text-xs">
          <span className="capitalize">{r.type}</span>
          <button onClick={() => deleteResource(r._id)}>
            <FiTrash2 className="text-gray-400 hover:text-red-500" />
          </button>
        </div>
      ))}
    </div>
  );
};
